<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snappy - Registro Domiciliario</title>
    <link rel="stylesheet" href="css\registroDomiciliario.css">
</head>
<body>
    <!-- Encabezado -->
    <header class="encabezado">
        <div class="logo">
            <img src="..\imagenes/logo-snappy.png" alt="Snappy" class="imagen-logo-header">
        </div>
    </header>

    <!-- Vista de Registro -->
    <main class="contenedor-formulario">
        <div class="modal-formulario aparicion-gradual">
            <button class="boton-cerrar" onclick="volverASeleccion()">✕</button>
            <h2 class="titulo-formulario">Registro Domiciliario</h2>
            
            <div id="contenedor-mensajes-registro" class="contenedor-mensajes"></div>
            
            <form id="formulario-registro" class="formulario-registro">
                <div class="grilla-formulario">
                    <div class="grupo-formulario">
                        <input 
                            type="text" 
                            class="entrada-formulario entrada-nombre-completo" 
                            id="nombre-completo" 
                            name="nombreCompleto"
                            placeholder="Nombre completo" 
                            required
                            autocomplete="name"
                        >
                    </div>
                    <div class="grupo-formulario">
                        <input 
                            type="email" 
                            class="entrada-formulario entrada-correo-domiciliario" 
                            id="correo-domiciliario" 
                            name="correoDomiciliario"
                            placeholder="Correo electrónico" 
                            required
                            autocomplete="email"
                        >
                    </div>
                    <div class="grupo-formulario">
                        <input 
                            type="text" 
                            class="entrada-formulario entrada-cedula" 
                            id="cedula" 
                            name="cedula"
                            placeholder="Cédula de ciudadanía" 
                            required
                            autocomplete="off"
                            pattern="[0-9]{8,10}"
                        >
                    </div>
                    <div class="grupo-formulario">
                        <input 
                            type="password" 
                            class="entrada-formulario entrada-contrasena-domiciliario" 
                            id="contrasena-domiciliario" 
                            name="contrasenaDomiciliario"
                            placeholder="Contraseña" 
                            required
                            autocomplete="new-password"
                            minlength="6"
                        >
                    </div>
                    <div class="grupo-formulario grupo-completo">
                        <input 
                            type="tel" 
                            class="entrada-formulario entrada-telefono-domiciliario" 
                            id="telefono-domiciliario" 
                            name="telefonoDomiciliario"
                            placeholder="Teléfono / WhatsApp" 
                            required
                            autocomplete="tel"
                            pattern="[0-9]{10,}"
                        >
                    </div>
                    <div class="grupo-formulario grupo-completo">
                        <select 
                            class="entrada-formulario entrada-tipo-vehiculo" 
                            id="tipo-vehiculo" 
                            name="tipoVehiculo"
                            required
                        >
                            <option value="">Tipo de vehículo</option>
                            <option value="moto">Motocicleta</option>
                            <option value="bicicleta">Bicicleta</option>
                            <option value="carro">Carro</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="boton-registrar-iniciar">
                    Registrarme e iniciar sesión
                </button>
            </form>
        </div>
    </main>

    <script>
        // Variables específicas de la vista de registro
        let datosDomiciliario = null;
        let validacionActiva = false;

        // Función para volver a la selección
        function volverASeleccion() {
            if (confirm('¿Deseas volver al menú principal? Los datos ingresados se perderán.')) {
                window.location.href = 'seleccionDomiciliario.html';
            }
        }

        // Función para validar correo electrónico
        function validarCorreoElectronico(correo) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(correo);
        }

        // Validación en tiempo real
        function configurarValidacionTiempoReal() {
            const entradas = document.querySelectorAll('.entrada-formulario');
            
            entradas.forEach(entrada => {
                entrada.addEventListener('input', function() {
                    validarCampo(this);
                });
                
                entrada.addEventListener('blur', function() {
                    validarCampo(this);
                });
            });
        }

        // Validar campo individual
        function validarCampo(campo) {
            const valor = campo.value.trim();
            const nombre = campo.name;
            let esValido = true;

            // Limpiar clases previas
            campo.classList.remove('entrada-valida', 'entrada-invalida');

            switch(nombre) {
                case 'nombreCompleto':
                    esValido = valor.length >= 3;
                    break;
                case 'correoDomiciliario':
                    esValido = validarCorreoElectronico(valor);
                    break;
                case 'cedula':
                    esValido = valor.length >= 8 && valor.length <= 10 && /^\d+$/.test(valor);
                    break;
                case 'contrasenaDomiciliario':
                    esValido = valor.length >= 6;
                    break;
                case 'telefonoDomiciliario':
                    esValido = valor.length >= 10 && /^\d+$/.test(valor);
                    break;
                case 'tipoVehiculo':
                    esValido = valor !== '';
                    break;
            }

            // Aplicar clase visual
            if (valor.length > 0) {
                campo.classList.add(esValido ? 'entrada-valida' : 'entrada-invalida');
            }

            return esValido;
        }

        // Manejo del formulario de registro
        document.getElementById('formulario-registro').addEventListener('submit', function(evento) {
            evento.preventDefault();
            
            const botonEnvio = this.querySelector('.boton-registrar-iniciar');
            const datosFormulario = {
                nombreCompleto: document.getElementById('nombre-completo').value.trim(),
                correoDomiciliario: document.getElementById('correo-domiciliario').value.trim(),
                cedula: document.getElementById('cedula').value.trim(),
                contrasenaDomiciliario: document.getElementById('contrasena-domiciliario').value,
                telefonoDomiciliario: document.getElementById('telefono-domiciliario').value.trim(),
                tipoVehiculo: document.getElementById('tipo-vehiculo').value
            };

            // Validar todos los campos
            const camposValidos = Object.keys(datosFormulario).every(campo => {
                const elemento = document.getElementById(campo.replace('Domiciliario', '-domiciliario').replace('Completo', '-completo').replace('Vehiculo', '-vehiculo'));
                return validarCampo(elemento);
            });

            if (!camposValidos) {
                mostrarMensajeRegistro('Por favor, completa todos los campos correctamente.', 'error');
                return;
            }

            // Validaciones específicas
            if (!validarCorreoElectronico(datosFormulario.correoDomiciliario)) {
                mostrarMensajeRegistro('Por favor ingresa un correo electrónico válido', 'error');
                return;
            }

            if (datosFormulario.contrasenaDomiciliario.length < 6) {
                mostrarMensajeRegistro('La contraseña debe tener al menos 6 caracteres', 'error');
                return;
            }

            if (datosFormulario.cedula.length < 8 || datosFormulario.cedula.length > 10 || !/^\d+$/.test(datosFormulario.cedula)) {
                mostrarMensajeRegistro('La cédula debe tener entre 8 y 10 dígitos numéricos', 'error');
                return;
            }

            if (datosFormulario.telefonoDomiciliario.length < 10 || !/^\d+$/.test(datosFormulario.telefonoDomiciliario)) {
                mostrarMensajeRegistro('El teléfono debe tener al menos 10 dígitos numéricos', 'error');
                return;
            }

            // Estado de carga
            botonEnvio.classList.add('boton-cargando');
            botonEnvio.disabled = true;

            // Enviar al backend
            const payload = {
                nombre: datosFormulario.nombreCompleto,
                correo: datosFormulario.correoDomiciliario,
                telefono: datosFormulario.telefonoDomiciliario,
                password: datosFormulario.contrasenaDomiciliario,
                tipo_usuario: 'DOMICILIARIO'
            };

            fetch('http://localhost/SnappyVistas/database/registro.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(async (r) => {
                const data = await r.json().catch(() => ({}));
                if (!r.ok || !data.success) throw new Error(data.error || 'Error registrando domiciliario');
                mostrarMensajeRegistro('Registro exitoso. Redirigiendo al panel de control...', 'exito');
                setTimeout(() => { window.location.href = 'dashboardDomiciliario.html'; }, 1200);
            })
            .catch((e) => {
                mostrarMensajeRegistro(e.message || 'Error en el registro', 'error');
            })
            .finally(() => {
                botonEnvio.classList.remove('boton-cargando');
                botonEnvio.disabled = false;
            });
        });

        // Función para mostrar mensajes
        function mostrarMensajeRegistro(mensaje, tipo) {
            const contenedor = document.getElementById('contenedor-mensajes-registro');
            const claseCSS = tipo === 'error' ? 'mensaje-error' : 'mensaje-exito';
            
            contenedor.innerHTML = `<div class="${claseCSS}">${mensaje}</div>`;
            
            // Limpiar mensaje después de 5 segundos para mensajes de error
            if (tipo === 'error') {
                setTimeout(() => {
                    contenedor.innerHTML = '';
                }, 5000);
            }
        }

        // Inicializar vista
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Vista de registro domiciliario cargada');
            configurarValidacionTiempoReal();
        });
    </script>
</body>
</html>
